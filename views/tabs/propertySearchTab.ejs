<section id="propertySearchTab" class="tab-content hidden">
  <div class="max-w-6xl mx-auto">
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
      <!-- Header -->
      <div class="bg-gradient-to-r from-emerald-600 to-teal-600 px-8 py-6">
        <h2 class="text-2xl font-bold text-white">Property Search</h2>
        <p class="text-emerald-100 mt-1">Find and save your dream home. Saved properties will be visible to your loan officer.</p>
      </div>
      
      <div class="p-8">
        <!-- Search Form -->
        <div class="bg-gray-50 rounded-lg p-6 mb-8">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
              <div class="relative">
                <svg class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <input type="text" id="property-location" placeholder="City, State or ZIP" 
                  class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Min Price</label>
              <select id="property-min-price" class="w-full py-3 px-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                <option value="">No Min</option>
                <option value="100000">$100,000</option>
                <option value="200000">$200,000</option>
                <option value="300000">$300,000</option>
                <option value="400000">$400,000</option>
                <option value="500000">$500,000</option>
                <option value="750000">$750,000</option>
                <option value="1000000">$1,000,000</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Max Price</label>
              <select id="property-max-price" class="w-full py-3 px-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                <option value="">No Max</option>
                <option value="200000">$200,000</option>
                <option value="300000">$300,000</option>
                <option value="400000" selected>$400,000</option>
                <option value="500000">$500,000</option>
                <option value="750000">$750,000</option>
                <option value="1000000">$1,000,000</option>
                <option value="2000000">$2,000,000</option>
              </select>
            </div>
          </div>
          
          <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mt-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Beds</label>
              <select id="property-beds" class="w-full py-3 px-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                <option value="">Any</option>
                <option value="1">1+</option>
                <option value="2">2+</option>
                <option value="3">3+</option>
                <option value="4">4+</option>
                <option value="5">5+</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Baths</label>
              <select id="property-baths" class="w-full py-3 px-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                <option value="">Any</option>
                <option value="1">1+</option>
                <option value="2">2+</option>
                <option value="3">3+</option>
                <option value="4">4+</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Type</label>
              <select id="property-type" class="w-full py-3 px-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                <option value="">Any</option>
                <option value="house">House</option>
                <option value="condo">Condo</option>
                <option value="townhouse">Townhouse</option>
                <option value="multi-family">Multi-Family</option>
              </select>
            </div>
            <div class="col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-2">&nbsp;</label>
              <button type="button" id="search-properties-btn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-3 rounded-lg transition flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                Search Properties
              </button>
            </div>
          </div>
        </div>
        
        <!-- Budget Indicator -->
        <% if (typeof preApprovedAmount !== 'undefined' && preApprovedAmount > 0) { %>
        <div class="bg-emerald-50 border border-emerald-200 rounded-lg p-4 mb-6 flex items-center">
          <svg class="w-6 h-6 text-emerald-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <div>
            <span class="font-medium text-emerald-800">You're pre-approved for up to</span>
            <span class="text-emerald-700 font-bold ml-1">$<%= preApprovedAmount.toLocaleString() %></span>
          </div>
        </div>
        <% } %>
        
        <!-- Tabs: Search Results vs Saved -->
        <div class="flex border-b border-gray-200 mb-6">
          <button type="button" id="tab-search-results" class="px-6 py-3 font-medium text-blue-600 border-b-2 border-blue-600">
            Search Results
          </button>
          <button type="button" id="tab-saved-properties" class="px-6 py-3 font-medium text-gray-500 hover:text-gray-700">
            Saved Properties (<span id="saved-count">0</span>)
          </button>
        </div>
        
        <!-- Search Results -->
        <div id="search-results-panel">
          <div class="text-center py-12" id="search-empty-state">
            <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
            </svg>
            <h3 class="text-lg font-medium text-gray-500 mb-2">Start Your Home Search</h3>
            <p class="text-gray-400">Enter a location above to find properties in your area</p>
          </div>
          
          <div id="search-results-grid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Populated by JavaScript or API -->
          </div>
        </div>
        
        <!-- Saved Properties -->
        <div id="saved-properties-panel" class="hidden">
          <div id="saved-properties-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Populated from database -->
          </div>
          <div class="text-center py-12" id="saved-empty-state">
            <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
            </svg>
            <h3 class="text-lg font-medium text-gray-500 mb-2">No Saved Properties</h3>
            <p class="text-gray-400">Save properties you like by clicking the heart icon</p>
          </div>
        </div>
        
        <!-- Manual Property Entry -->
        <div class="mt-8 border-t border-gray-200 pt-8">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Add a Property Manually</h3>
          <p class="text-gray-500 mb-4">Found a property elsewhere? Add it here to share with your loan officer.</p>
          
          <form id="manual-property-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Street Address</label>
              <input type="text" name="address" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">City</label>
              <input type="text" name="city" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">State</label>
              <input type="text" name="state" required maxlength="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ZIP Code</label>
              <input type="text" name="zipCode" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Price</label>
              <div class="relative">
                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                <input type="number" name="price" class="w-full pl-8 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Listing URL (optional)</label>
              <input type="url" name="listingUrl" placeholder="https://..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
              <textarea name="notes" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500" placeholder="Any notes about this property..."></textarea>
            </div>
            <div class="md:col-span-2">
              <button type="submit" class="bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-2 px-6 rounded-lg transition">
                Save Property
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const tabSearchResults = document.getElementById('tab-search-results');
  const tabSavedProperties = document.getElementById('tab-saved-properties');
  const searchResultsPanel = document.getElementById('search-results-panel');
  const savedPropertiesPanel = document.getElementById('saved-properties-panel');
  
  tabSearchResults.addEventListener('click', function() {
    tabSearchResults.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
    tabSearchResults.classList.remove('text-gray-500');
    tabSavedProperties.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
    tabSavedProperties.classList.add('text-gray-500');
    searchResultsPanel.classList.remove('hidden');
    savedPropertiesPanel.classList.add('hidden');
  });
  
  tabSavedProperties.addEventListener('click', function() {
    tabSavedProperties.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
    tabSavedProperties.classList.remove('text-gray-500');
    tabSearchResults.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
    tabSearchResults.classList.add('text-gray-500');
    savedPropertiesPanel.classList.remove('hidden');
    searchResultsPanel.classList.add('hidden');
    loadSavedProperties();
  });
  
  // Manual property form
  document.getElementById('manual-property-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    
    try {
      const response = await fetch('/api/properties/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          ...data,
          propertySource: 'Manual'
        })
      });
      
      if (response.ok) {
        alert('Property saved successfully!');
        this.reset();
        loadSavedProperties();
        updateSavedCount();
      }
    } catch (err) {
      console.error('Error saving property:', err);
    }
  });
  
  async function loadSavedProperties() {
    try {
      const response = await fetch('/api/properties/saved');
      const properties = await response.json();
      
      const grid = document.getElementById('saved-properties-grid');
      const emptyState = document.getElementById('saved-empty-state');
      
      if (properties.length === 0) {
        emptyState.classList.remove('hidden');
        grid.innerHTML = '';
      } else {
        emptyState.classList.add('hidden');
        grid.innerHTML = properties.map(p => createPropertyCard(p, true)).join('');
      }
      
      document.getElementById('saved-count').textContent = properties.length;
    } catch (err) {
      console.error('Error loading saved properties:', err);
    }
  }
  
  async function updateSavedCount() {
    try {
      const response = await fetch('/api/properties/saved');
      const properties = await response.json();
      document.getElementById('saved-count').textContent = properties.length;
    } catch (err) {
      console.error('Error updating saved count:', err);
    }
  }
  
  function createPropertyCard(property, isSaved = false) {
    const priceFormatted = property.Price ? '$' + parseInt(property.Price).toLocaleString() : 'Price N/A';
    const address = property.Address || 'Address not available';
    const location = [property.City, property.State, property.ZipCode].filter(Boolean).join(', ');
    
    return `
      <div class="bg-white border border-gray-200 rounded-lg overflow-hidden hover:shadow-lg transition">
        <div class="h-48 bg-gradient-to-br from-gray-200 to-gray-300 relative flex items-center justify-center">
          ${property.ImageURL ? 
            `<img src="${property.ImageURL}" alt="Property" class="w-full h-full object-cover">` : 
            `<svg class="w-16 h-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
            </svg>`
          }
          <button class="absolute top-3 right-3 w-10 h-10 bg-white rounded-full shadow flex items-center justify-center hover:bg-red-50 transition save-property-btn" data-id="${property.SavedPropertyID || ''}">
            <svg class="w-6 h-6 ${isSaved ? 'text-red-500 fill-current' : 'text-gray-400'}" fill="${isSaved ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
            </svg>
          </button>
        </div>
        <div class="p-4">
          <div class="text-xl font-bold text-gray-900 mb-1">${priceFormatted}</div>
          <div class="text-sm text-gray-500 mb-2">
            ${property.Bedrooms ? property.Bedrooms + ' bd' : ''} 
            ${property.Bathrooms ? '• ' + property.Bathrooms + ' ba' : ''} 
            ${property.SquareFeet ? '• ' + property.SquareFeet.toLocaleString() + ' sqft' : ''}
          </div>
          <div class="text-sm text-gray-700 font-medium">${address}</div>
          <div class="text-sm text-gray-500">${location}</div>
          ${property.Notes ? `<div class="mt-2 text-sm text-gray-500 italic">"${property.Notes}"</div>` : ''}
          ${property.ListingURL ? `
            <a href="${property.ListingURL}" target="_blank" class="mt-3 inline-flex items-center text-sm text-emerald-600 hover:text-emerald-700">
              View Listing
              <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
              </svg>
            </a>
          ` : ''}
        </div>
      </div>
    `;
  }
  
  // Initial load
  updateSavedCount();
  
  // Search button placeholder
  document.getElementById('search-properties-btn').addEventListener('click', function() {
    const location = document.getElementById('property-location').value;
    if (!location) {
      alert('Please enter a location to search');
      return;
    }
    
    // Placeholder - would integrate with property API
    alert('Property search would integrate with Zillow, Realtor.com, or MLS API.\n\nFor now, use the manual entry form below to add properties.');
  });
});
</script>

