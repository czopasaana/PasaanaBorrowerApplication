<section id="videoCallTab" class="tab-content hidden">
  <div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
      <!-- Header -->
      <div class="bg-gradient-to-r from-purple-600 to-indigo-600 px-8 py-6">
        <h2 class="text-2xl font-bold text-white">Schedule a Video Call</h2>
        <p class="text-purple-100 mt-1">Meet face-to-face with your loan officer from the comfort of your home</p>
      </div>
      
      <div class="p-8">
        <% if (typeof loanOfficer !== 'undefined' && loanOfficer) { %>
        <!-- Loan Officer Card -->
        <div class="bg-gray-50 rounded-lg p-6 mb-8 flex items-center">
          <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-full flex items-center justify-center text-white text-xl font-bold mr-4">
            <%= loanOfficer.FirstName ? loanOfficer.FirstName.charAt(0) : 'L' %><%= loanOfficer.LastName ? loanOfficer.LastName.charAt(0) : 'O' %>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-gray-900"><%= loanOfficer.FirstName %> <%= loanOfficer.LastName %></h3>
            <p class="text-gray-500">Your Loan Officer â€¢ NMLS# <%= loanOfficer.NMLS_ID || 'N/A' %></p>
          </div>
        </div>
        <% } %>
        
        <!-- Upcoming Calls -->
        <div class="mb-8">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Upcoming Video Calls</h3>
          <div id="upcoming-calls-container">
            <div class="text-center py-8 bg-gray-50 rounded-lg" id="no-upcoming-calls">
              <svg class="w-12 h-12 mx-auto text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
              </svg>
              <p class="text-gray-500">No upcoming video calls scheduled</p>
            </div>
          </div>
        </div>
        
        <!-- Schedule New Call -->
        <div class="border-t border-gray-200 pt-8">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Schedule a New Call</h3>
          
          <form id="schedule-call-form" class="space-y-6">
            <!-- Topic Selection -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">What would you like to discuss?</label>
              <select id="call-topic" name="topic" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                <option value="">Select a topic...</option>
                <option value="pre-approval">Pre-Approval Questions</option>
                <option value="application-help">Help with Application</option>
                <option value="document-review">Document Review</option>
                <option value="rate-discussion">Rate & Terms Discussion</option>
                <option value="closing-prep">Closing Preparation</option>
                <option value="general">General Questions</option>
                <option value="other">Other</option>
              </select>
            </div>
            
            <!-- Date Selection -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Select a Date</label>
              <div class="grid grid-cols-7 gap-2" id="date-picker">
                <!-- Generated by JavaScript -->
              </div>
            </div>
            
            <!-- Time Selection -->
            <div id="time-selection" class="hidden">
              <label class="block text-sm font-medium text-gray-700 mb-2">Select a Time</label>
              <div class="grid grid-cols-4 gap-2" id="time-slots">
                <!-- Generated by JavaScript -->
              </div>
            </div>
            
            <!-- Duration -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Call Duration</label>
              <div class="flex gap-4">
                <label class="flex items-center">
                  <input type="radio" name="duration" value="15" class="mr-2 text-purple-600 focus:ring-purple-500">
                  <span>15 min</span>
                </label>
                <label class="flex items-center">
                  <input type="radio" name="duration" value="30" checked class="mr-2 text-purple-600 focus:ring-purple-500">
                  <span>30 min</span>
                </label>
                <label class="flex items-center">
                  <input type="radio" name="duration" value="60" class="mr-2 text-purple-600 focus:ring-purple-500">
                  <span>1 hour</span>
                </label>
              </div>
            </div>
            
            <!-- Notes -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Additional Notes (Optional)</label>
              <textarea name="notes" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="Anything specific you'd like to cover?"></textarea>
            </div>
            
            <!-- Submit -->
            <button type="submit" id="schedule-btn" disabled class="w-full bg-purple-600 hover:bg-purple-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white font-medium py-3 rounded-lg transition flex items-center justify-center">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
              Schedule Video Call
            </button>
          </form>
        </div>
        
        <!-- Video Call Tips -->
        <div class="mt-8 bg-purple-50 rounded-lg p-6">
          <h4 class="font-semibold text-purple-900 mb-3">Tips for Your Video Call</h4>
          <ul class="space-y-2 text-sm text-purple-800">
            <li class="flex items-start">
              <svg class="w-5 h-5 mr-2 text-purple-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
              Find a quiet, well-lit space for the call
            </li>
            <li class="flex items-start">
              <svg class="w-5 h-5 mr-2 text-purple-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
              Have any relevant documents ready to share
            </li>
            <li class="flex items-start">
              <svg class="w-5 h-5 mr-2 text-purple-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
              Test your camera and microphone beforehand
            </li>
            <li class="flex items-start">
              <svg class="w-5 h-5 mr-2 text-purple-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
              Write down any questions you want to ask
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const datePicker = document.getElementById('date-picker');
  const timeSelection = document.getElementById('time-selection');
  const timeSlots = document.getElementById('time-slots');
  const scheduleBtn = document.getElementById('schedule-btn');
  
  let selectedDate = null;
  let selectedTime = null;
  
  // Generate date options for next 14 days (excluding weekends)
  function generateDatePicker() {
    const today = new Date();
    let html = '';
    let daysAdded = 0;
    let dayOffset = 1;
    
    while (daysAdded < 14) {
      const date = new Date(today);
      date.setDate(today.getDate() + dayOffset);
      
      // Skip weekends
      if (date.getDay() !== 0 && date.getDay() !== 6) {
        const dateStr = date.toISOString().split('T')[0];
        const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
        const dayNum = date.getDate();
        const monthName = date.toLocaleDateString('en-US', { month: 'short' });
        
        html += `
          <button type="button" class="date-option p-3 border border-gray-200 rounded-lg text-center hover:border-purple-500 hover:bg-purple-50 transition" data-date="${dateStr}">
            <div class="text-xs text-gray-500">${dayName}</div>
            <div class="text-lg font-semibold">${dayNum}</div>
            <div class="text-xs text-gray-500">${monthName}</div>
          </button>
        `;
        daysAdded++;
      }
      dayOffset++;
    }
    
    datePicker.innerHTML = html;
    
    // Add click handlers
    document.querySelectorAll('.date-option').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.date-option').forEach(b => {
          b.classList.remove('border-purple-600', 'bg-purple-50');
          b.classList.add('border-gray-200');
        });
        this.classList.remove('border-gray-200');
        this.classList.add('border-purple-600', 'bg-purple-50');
        selectedDate = this.dataset.date;
        generateTimeSlots();
        timeSelection.classList.remove('hidden');
        updateScheduleButton();
      });
    });
  }
  
  // Generate time slots
  function generateTimeSlots() {
    const times = [
      '9:00 AM', '9:30 AM', '10:00 AM', '10:30 AM',
      '11:00 AM', '11:30 AM', '1:00 PM', '1:30 PM',
      '2:00 PM', '2:30 PM', '3:00 PM', '3:30 PM',
      '4:00 PM', '4:30 PM'
    ];
    
    // Randomly mark some as unavailable for demo
    const unavailable = new Set();
    for (let i = 0; i < 4; i++) {
      unavailable.add(Math.floor(Math.random() * times.length));
    }
    
    let html = '';
    times.forEach((time, idx) => {
      const isAvailable = !unavailable.has(idx);
      html += `
        <button type="button" class="time-option py-2 px-4 border rounded-lg text-center transition
          ${isAvailable ? 'border-gray-200 hover:border-purple-500 hover:bg-purple-50' : 'border-gray-100 bg-gray-50 text-gray-400 cursor-not-allowed'}"
          data-time="${time}" ${!isAvailable ? 'disabled' : ''}>
          ${time}
        </button>
      `;
    });
    
    timeSlots.innerHTML = html;
    
    // Add click handlers
    document.querySelectorAll('.time-option:not([disabled])').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.time-option').forEach(b => {
          b.classList.remove('border-purple-600', 'bg-purple-50');
          if (!b.disabled) b.classList.add('border-gray-200');
        });
        this.classList.remove('border-gray-200');
        this.classList.add('border-purple-600', 'bg-purple-50');
        selectedTime = this.dataset.time;
        updateScheduleButton();
      });
    });
  }
  
  function updateScheduleButton() {
    const topic = document.getElementById('call-topic').value;
    scheduleBtn.disabled = !(selectedDate && selectedTime && topic);
  }
  
  document.getElementById('call-topic').addEventListener('change', updateScheduleButton);
  
  // Form submission
  document.getElementById('schedule-call-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
      date: selectedDate,
      time: selectedTime,
      topic: formData.get('topic'),
      duration: formData.get('duration'),
      notes: formData.get('notes')
    };
    
    try {
      const response = await fetch('/api/video-calls/schedule', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      
      if (response.ok) {
        const result = await response.json();
        alert(`Video call scheduled!\n\nDate: ${selectedDate}\nTime: ${selectedTime}\n\nYou'll receive a confirmation email with the meeting link.`);
        // Reset form
        this.reset();
        selectedDate = null;
        selectedTime = null;
        document.querySelectorAll('.date-option, .time-option').forEach(b => {
          b.classList.remove('border-purple-600', 'bg-purple-50');
          if (!b.disabled) b.classList.add('border-gray-200');
        });
        timeSelection.classList.add('hidden');
        updateScheduleButton();
        loadUpcomingCalls();
      }
    } catch (err) {
      console.error('Error scheduling call:', err);
      alert('Error scheduling call. Please try again.');
    }
  });
  
  async function loadUpcomingCalls() {
    try {
      const response = await fetch('/api/video-calls/upcoming');
      const calls = await response.json();
      
      const container = document.getElementById('upcoming-calls-container');
      const noCallsDiv = document.getElementById('no-upcoming-calls');
      
      if (calls.length === 0) {
        noCallsDiv.classList.remove('hidden');
      } else {
        noCallsDiv.classList.add('hidden');
        container.innerHTML = calls.map(call => `
          <div class="flex items-center justify-between bg-purple-50 rounded-lg p-4 mb-3">
            <div class="flex items-center">
              <div class="bg-purple-600 text-white rounded-lg p-3 mr-4">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                </svg>
              </div>
              <div>
                <div class="font-semibold text-gray-900">${call.Topic}</div>
                <div class="text-sm text-gray-500">${new Date(call.ScheduledDate).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })} at ${call.ScheduledTime}</div>
              </div>
            </div>
            <div class="flex items-center gap-3">
              ${call.MeetingLink ? `
                <a href="${call.MeetingLink}" target="_blank" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
                  Join Call
                </a>
              ` : `
                <span class="text-sm text-gray-500">Link sent via email</span>
              `}
              <button class="text-red-500 hover:text-red-700 cancel-call-btn" data-id="${call.BookingID}">
                Cancel
              </button>
            </div>
          </div>
        `).join('');
        
        // Add cancel handlers
        document.querySelectorAll('.cancel-call-btn').forEach(btn => {
          btn.addEventListener('click', async function() {
            if (confirm('Are you sure you want to cancel this call?')) {
              await fetch('/api/video-calls/cancel', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ bookingId: this.dataset.id })
              });
              loadUpcomingCalls();
            }
          });
        });
      }
    } catch (err) {
      console.error('Error loading upcoming calls:', err);
    }
  }
  
  // Initialize
  generateDatePicker();
  loadUpcomingCalls();
});
</script>

