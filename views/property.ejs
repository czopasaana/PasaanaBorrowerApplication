<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title><%= property.Address %> - Pasaana</title>
  <meta name="description" content="Explore detailed information about <%= property.Address %>">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.5/dist/tailwind.min.css" rel="stylesheet">
  <!-- Swiper CSS for image carousel -->
  <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css">
  <!-- Custom Styles -->
  <link rel="stylesheet" href="/styles.css">
  <!-- Include jQuery for AJAX requests -->
   <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
   <!-- First include the Font Awesome CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.1/css/all.min.css">
  <style>
    /* Custom scrollbar for the image carousel */
    .swiper-container::-webkit-scrollbar {
      display: none;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <!-- Navigation Bar -->
  <%- include('partials/navbar.ejs') %>

  <!-- Helper Functions -->
  <%
    function formatNumber(value) {
      return value != null ? value.toLocaleString() : 'N/A';
    }

    function formatCurrency(value) {
      return value != null ? '$' + value.toLocaleString() : 'N/A';
    }

    function formatText(value) {
      return value != null && value.toString().trim() !== '' ? value : 'N/A';
    }

    // Add this function to format category names
    function formatCategoryName(category) {
      return category.replace(/([a-z])([A-Z])/g, '$1 $2');
    }
  %>

  <!-- Prepare Image Categories for JavaScript -->
  <%
    // Group Images by category for use in JavaScript
    const imagesByCategory = {};

    // Add an "All" category that includes all images
    imagesByCategory['All'] = images;

    images.forEach(image => {
      const category = image.Category || 'Other';
      if (!imagesByCategory[category]) {
        imagesByCategory[category] = [];
      }
      imagesByCategory[category].push(image);
    });

    // Get unique categories and ensure "All" is first
    const imageCategories = Object.keys(imagesByCategory);

    // Move "All" category to the first position if it's not already there
    const allIndex = imageCategories.indexOf('All');
    if (allIndex > 0) {
      imageCategories.splice(allIndex, 1);
      imageCategories.unshift('All');
    }
  %>

  <!-- Hero Section -->
  <div class="container mx-auto px-4 py-6">
    <!-- Back to Search and Logo -->
    <div class="flex justify-between items-center mb-4">
      <a href="/explorer" class="text-blue-600 hover:underline">&larr; Back to Search</a>
      <div class="flex space-x-4">
        <button class="text-gray-600 hover:text-blue-600">Save</button>
        <button class="text-gray-600 hover:text-blue-600">Share</button>
        <button class="text-gray-600 hover:text-blue-600">Hide</button>
      </div>
    </div>

    <!-- Images Section -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <!-- Main Image -->
      <div class="md:col-span-2">
        <% 
          // Find the image with Category 'Main' or fallback to the first image
          const mainImage = images.find(image => image.Category === 'Main') || images[0];
        %>
        <% if (mainImage) { %>
          <img src="<%= mainImage.Url %>" alt="Featured Image" class="w-full h-full object-cover rounded-lg">
        <% } else { %>
          <div class="w-full h-full bg-gray-300 flex items-center justify-center rounded-lg">
            <span class="text-gray-600">No Image Available</span>
          </div>
        <% } %>
      </div>
      <!-- Thumbnail Images -->
      <div class="grid grid-cols-2 gap-2">
        <% images.slice(1, 5).forEach(function(image) { %>
          <img src="<%= image.Url %>" alt="Property Image" class="w-full h-32 object-cover rounded-lg">
        <% }); %>
        <% if (images.length > 5) { %>
          <!-- 'See all photos' button -->
          <div class="relative w-full h-32">
            <img src="<%= images[5].Url %>" alt="Property Image" class="w-full h-full object-cover rounded-lg">
            <button onclick="openPhotoOverlay()" class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center text-white text-lg font-semibold rounded-lg">
              See all photos
            </button>
          </div>
        <% } %>
      </div>
    </div>

    <!-- Photo Overlay -->
    <div id="photo-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
      <!-- Overlay Background to capture clicks -->
      <div class="absolute inset-0" id="overlay-background"></div>

      <!-- Overlay Content -->
      <div id="photo-overlay-content" class="bg-white w-4/5 h-4/5 overflow-y-auto relative rounded-lg">
        <!-- Sticky Header -->
        <div class="sticky top-0 bg-white z-20">
          <!-- Header content -->
          <div class="flex items-center justify-start px-4 py-4 border-b space-x-4">
            <!-- Back to Listing Button -->
            <button onclick="closePhotoOverlay()" class="bg-gray-800 text-white px-4 py-2 rounded-md focus:outline-none">
              &larr; Back to listing
            </button>
            <!-- Category Buttons -->
            <div class="flex flex-wrap items-center space-x-2">
              <% imageCategories.forEach(function(category, index) { %>
                <button
                  onclick="showOverlayGalleryCategory('<%= category.replace(/'/g, "\\'") %>', this)"
                  class="overlay-category-button py-2 px-4 rounded <%= index === 0 ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800' %> hover:bg-blue-700 focus:outline-none">
                  <%= formatCategoryName(category) %>
                </button>
              <% }); %>
            </div>
          </div>
        </div>
        <!-- Overlay Content Body -->
        <div class="container mx-auto px-4 py-6">
          <!-- Images -->
          <% imageCategories.forEach(function(category, index) { %>
            <div id="overlay-gallery-category-<%= category.replace(/\s+/g, '-') %>" class="overlay-gallery-category <%= index === 0 ? '' : 'hidden' %>">
              <div class="grid grid-cols-2 gap-4">
                <% imagesByCategory[category].forEach(function(image) { %>
                  <img src="<%= image.Url %>" alt="<%= image.Category %> <%= image.ImageNumber %>" class="w-full h-auto object-cover rounded-lg">
                <% }); %>
              </div>
            </div>
          <% }); %>
        </div>
      </div>
    </div>

    <!-- Property Summary -->
    <div class="mb-6">
      <h1 class="text-3xl font-bold mb-1"><%= property.Address %></h1>
      <p class="text-xl text-gray-600 mb-2"><%= property.City %>, <%= property.State %> <%= property.ZipCode %></p>
      <div class="flex flex-wrap items-center space-x-4 mb-2">
        <h2 class="text-3xl font-semibold"><%= formatCurrency(property.ListingPrice) %></h2>
        <span class="text-gray-600">
          <%= property.Bedrooms != null ? property.Bedrooms : 'N/A' %> bds |
          <%= property.TotalBathrooms != null ? property.TotalBathrooms : 'N/A' %> ba |
          <%= formatNumber(property.PropertySize) %> sqft
        </span>
      </div>
      <p class="text-gray-600 mb-4">Est. Mortgage: <span class="font-semibold"><%= formatCurrency(property.EstimatedMortgage) %>/month</span></p>
      <!-- CTA Buttons -->
      <div class="flex flex-wrap items-center space-x-4">
        <button class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 focus:outline-none">Request a Tour</button>
        <button class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 focus:outline-none">Contact Agent</button>
        <button class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 focus:outline-none">Take a Virtual Tour</button>
        <button class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 focus:outline-none">Customize Home</button>
      </div>
    </div>

    <!-- Property Details Icons -->
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
      <!-- Property Type -->
      <div class="flex items-center gap-3 p-3 bg-white rounded-lg hover:shadow-md transition-shadow">
        <i class="fas fa-home w-7 h-7 text-blue-600 flex-shrink-0 text-xl"></i>
        <div>
          <span class="text-sm text-gray-500 block">Type</span>
          <span class="font-semibold"><%= formatText(property.PropertyType) %></span>
        </div>
      </div>

      <!-- Year Built -->
      <div class="flex items-center gap-3 p-3 bg-white rounded-lg hover:shadow-md transition-shadow">
        <i class="fas fa-calendar-alt w-7 h-7 text-blue-600 flex-shrink-0 text-xl"></i>
        <div>
          <span class="text-sm text-gray-500 block">Year Built</span>
          <span class="font-semibold"><%= property.YearBuilt != null ? property.YearBuilt : 'N/A' %></span>
        </div>
      </div>

      <!-- Lot Size -->
      <div class="flex items-center gap-3 p-3 bg-white rounded-lg hover:shadow-md transition-shadow">
        <i class="fas fa-ruler-combined w-7 h-7 text-blue-600 flex-shrink-0 text-xl"></i>
        <div>
          <span class="text-sm text-gray-500 block">Lot Size</span>
          <span class="font-semibold"><%= property.LotSize != null ? property.LotSize + ' Acres' : 'N/A' %></span>
        </div>
      </div>

      <!-- Price per Sqft -->
      <div class="flex items-center gap-3 p-3 bg-white rounded-lg hover:shadow-md transition-shadow">
        <i class="fas fa-dollar-sign w-7 h-7 text-blue-600 flex-shrink-0 text-xl"></i>
        <div>
          <span class="text-sm text-gray-500 block">Price/Sqft</span>
          <span class="font-semibold"><%= formatCurrency(property.PricePerSqFt) %></span>
        </div>
      </div>

      <!-- HOA -->
      <div class="flex items-center gap-3 p-3 bg-white rounded-lg hover:shadow-md transition-shadow">
        <i class="fas fa-building w-7 h-7 text-blue-600 flex-shrink-0 text-xl"></i>
        <div>
          <span class="text-sm text-gray-500 block">HOA</span>
          <span class="font-semibold"><%= property.HOAFees != null ? formatCurrency(property.HOAFees) + '/month' : 'N/A' %></span>
        </div>
      </div>

      <!-- Taxes -->
      <% if (property.Taxes) { %>
      <div class="flex items-center gap-3 p-3 bg-white rounded-lg hover:shadow-md transition-shadow">
        <i class="fas fa-file-invoice-dollar w-7 h-7 text-blue-600 flex-shrink-0 text-xl"></i>
        <div>
          <span class="text-sm text-gray-500 block">Taxes</span>
          <span class="font-semibold"><%= formatCurrency(property.Taxes) %>/year</span>
        </div>
      </div>
      <% } %>
    </div>

    <!-- Special Features Section -->
    <div class="mb-6 bg-gray-50 rounded-lg p-6">
      <h3 class="text-xl font-semibold mb-4">What's Special</h3>
      <div class="flex flex-wrap gap-2 mb-4">
        <span class="bg-gray-100 text-gray-800 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-200 transition-colors">
          Spacious backyard
        </span>
        <span class="bg-gray-100 text-gray-800 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-200 transition-colors">
          Modern kitchen
        </span>
        <span class="bg-gray-100 text-gray-800 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-200 transition-colors">
          Energy-efficient appliances
        </span>
        <span class="bg-gray-100 text-gray-800 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-200 transition-colors">
          Natural lighting
        </span>
        <span class="bg-gray-100 text-gray-800 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-200 transition-colors">
          Updated bathrooms
        </span>
        <span class="bg-gray-100 text-gray-800 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-200 transition-colors">
          Hardwood floors
        </span>
      </div>
      <p class="text-gray-700 leading-relaxed">
        This beautiful property offers an open floor plan with plenty of natural light, perfect for both entertaining and everyday living. Located in a friendly neighborhood close to shopping and schools.
      </p>
    </div>
  </div>

  <!-- Vertical Collapsible Sections -->
  <div class="container mx-auto px-4 py-6 space-y-4">

    <!-- Details Section -->
    <div class="bg-white rounded-lg shadow">
      <button class="toggle-button w-full flex justify-between items-center p-4 font-semibold text-xl border-b hover:bg-gray-50 transition-colors duration-200" onclick="toggleSection('details', this)">
        <span>Details</span>
        <svg class="toggle-arrow w-6 h-6 transition-transform duration-200" fill="currentColor" viewBox="0 0 20 20">
          <path d="M5.23 7.21a.75.75 0 011.06-.02L10 10.8l3.71-3.61a.75.75 0 011.04 1.08l-4.24 4.12a.75.75 0 01-1.04 0L5.21 8.27a.75.75 0 01.02-1.06z"/>
        </svg>
      </button>

      <div id="details" class="p-6">
        <!-- Add w-full to ensure full width and debug colors -->
        <div class="w-full grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
          <!-- Left Column - add debug background -->
          <div class="w-full space-y-6">
            <h2 class="text-2xl font-semibold text-gray-800 flex items-center space-x-2">
              <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
              </svg>
              <span>Property Details</span>
            </h2>
            
            <!-- Property details cards -->
            <div class="w-full grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div class="bg-gray-50 rounded-xl p-4 hover:bg-gray-100 transition-colors duration-200">
                <div class="text-sm text-gray-500 mb-1">Property Type</div>
                <div class="font-semibold text-gray-900"><%= formatText(property.PropertyType) %></div>
              </div>
              
              <div class="bg-gray-50 rounded-xl p-4 hover:bg-gray-100 transition-colors duration-200">
                <div class="text-sm text-gray-500 mb-1">Year Built</div>
                <div class="font-semibold text-gray-900"><%= property.YearBuilt != null ? property.YearBuilt : 'N/A' %></div>
              </div>
              
              <div class="bg-gray-50 rounded-xl p-4 hover:bg-gray-100 transition-colors duration-200">
                <div class="text-sm text-gray-500 mb-1">Garage Capacity</div>
                <div class="font-semibold text-gray-900"><%= property.GarageCapacity != null ? property.GarageCapacity : 'N/A' %></div>
              </div>
              
              <div class="bg-gray-50 rounded-xl p-4 hover:bg-gray-100 transition-colors duration-200">
                <div class="text-sm text-gray-500 mb-1">Price per Sq Ft</div>
                <div class="font-semibold text-gray-900"><%= formatCurrency(property.PricePerSqFt) %></div>
              </div>
            </div>
          </div>

          <!-- Right Column - add debug background -->
          <div class="w-full space-y-6">
            <h2 class="text-2xl font-semibold text-gray-800 flex items-center space-x-2">
              <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span>Additional Information</span>
            </h2>

            <!-- Additional info cards -->
            <div class="w-full grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div class="bg-gray-50 rounded-xl p-4 hover:bg-gray-100 transition-colors duration-200">
                <div class="text-sm text-gray-500 mb-1">Neighborhood</div>
                <div class="font-semibold text-gray-900">
                  <% if (neighborhoods && neighborhoods.length > 0) { %>
                    <%= formatText(neighborhoods[0].Name) %>
                  <% } else { %>
                    N/A
                  <% } %>
                </div>
              </div>

              <div class="bg-gray-50 rounded-xl p-4 hover:bg-gray-100 transition-colors duration-200">
                <div class="text-sm text-gray-500 mb-1">Annual Taxes</div>
                <div class="font-semibold text-gray-900"><%= formatCurrency(property.Taxes) %></div>
              </div>

              <div class="bg-gray-50 rounded-xl p-4 hover:bg-gray-100 transition-colors duration-200">
                <div class="text-sm text-gray-500 mb-1">Last Sold</div>
                <div class="font-semibold text-gray-900">
                  <%= property.LastSoldPrice != null ? formatCurrency(property.LastSoldPrice) + ' (' + property.YearLastSold + ')' : 'N/A' %>
                </div>
              </div>

              <div class="bg-gray-50 rounded-xl p-4 hover:bg-gray-100 transition-colors duration-200">
                <div class="text-sm text-gray-500 mb-1">Property Age</div>
                <div class="font-semibold text-gray-900"><%= property.Age != null ? property.Age + ' years' : 'N/A' %></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Bedrooms and Bathrooms -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <!-- Bedrooms -->
          <section>
            <h3 class="text-2xl font-semibold mb-4 flex items-center">
              <svg class="w-6 h-6 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4h16v2H4V4zm0 4h16v12H4V8zm6 2v8h4v-8h-4z"/>
              </svg>
              Bedrooms
            </h3>
            <div class="space-y-4">
              <% bedrooms.forEach(function(bedroom) { %>
                <div class="bg-gray-50 rounded-xl p-4 hover:bg-gray-100 transition-colors duration-200">
                  <h4 class="font-semibold mb-2 text-lg text-gray-800">Bedroom <%= bedroom.BedroomNumber %></h4>
                  <div class="text-gray-600 pl-4">
                    <ul class="list-disc">
                      <li>Dimensions: <%= formatText(bedroom.Dimensions) %></li>
                    </ul>
                  </div>
                </div>
              <% }); %>
            </div>
          </section>

          <!-- Bathrooms -->
          <section>
            <h3 class="text-2xl font-semibold mb-4 flex items-center">
              <svg class="w-6 h-6 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10c0 1.1-.9 2-2 2H5c-1.1 0-2-.9-2-2V5c0-1.1.9-2 2-2h14c1.1 0 2 .9 2 2v5zm-2 2v7c0 1.1-.9 2-2 2H7c-1.1 0-2-.9-2-2v-7"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12H3"/>
              </svg>
              Bathrooms
            </h3>
            <div class="space-y-4">
              <% bathrooms.forEach(function(bathroom, index) { %>
                <div class="bg-gray-50 rounded-xl p-4 hover:bg-gray-100 transition-colors duration-200">
                  <h4 class="font-semibold mb-2 text-lg text-gray-800">Bathroom <%= index + 1 %></h4>
                  <div class="text-gray-600 pl-4">
                    <ul class="list-disc">
                      <li>Type: <%= formatText(bathroom.BathroomType) %></li>
                    </ul>
                  </div>
                </div>
              <% }); %>
            </div>
          </section>
        </div>
      </div>
    </div>

    <!-- Price History Section -->
    <div class="bg-white rounded-lg shadow">
      <button class="toggle-button w-full flex justify-between items-center p-4 font-semibold text-xl border-b hover:bg-gray-50 transition-colors duration-200" onclick="toggleSection('priceHistory', this)">
        <span>Price History</span>
        <svg class="toggle-arrow w-6 h-6 transition-transform duration-200" fill="currentColor" viewBox="0 0 20 20">
          <path d="M5.23 7.21a.75.75 0 011.06-.02L10 10.8l3.71-3.61a.75.75 0 011.04 1.08l-4.24 4.12a.75.75 0 01-1.04 0L5.21 8.27a.75.75 0 01.02-1.06z"/>
        </svg>
      </button>
      
      <div id="priceHistory" class="p-6 hidden">
        <section>
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-semibold">Price History</h3>
            <!-- Added export button -->
            <button class="flex items-center space-x-2 text-blue-600 hover:text-blue-800 transition-colors">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
              </svg>
              <span>Export History</span>
            </button>
          </div>

          <% if (priceHistory && priceHistory.length > 0) { %>
            <div class="overflow-x-auto rounded-lg border border-gray-200">
              <table class="w-full text-left border-collapse">
                <thead>
                  <tr class="bg-gray-100 border-b border-gray-200">
                    <th class="py-4 px-6 text-sm font-semibold text-gray-700">Date Listed</th>
                    <th class="py-4 px-6 text-sm font-semibold text-gray-700">Price</th>
                    <th class="py-4 px-6 text-sm font-semibold text-gray-700">Price per Sq Ft</th>
                    <th class="py-4 px-6 text-sm font-semibold text-gray-700">Days on Market</th>
                    <th class="py-4 px-6 text-sm font-semibold text-gray-700">Change</th>
                  </tr>
                </thead>
                <tbody>
                  <% priceHistory.forEach(function(entry, index) { 
                    const priceChange = index < priceHistory.length - 1 
                      ? entry.Price - priceHistory[index + 1].Price 
                      : 0;
                  %>
                    <tr class="border-b border-gray-100 last:border-0 hover:bg-gray-50 transition-colors">
                      <td class="py-4 px-6 text-gray-800">
                        <%= new Date(entry.DateListed).toLocaleDateString('en-US', { 
                          year: 'numeric', 
                          month: 'short', 
                          day: 'numeric' 
                        }) %>
                      </td>
                      <td class="py-4 px-6 font-medium"><%= formatCurrency(entry.Price) %></td>
                      <td class="py-4 px-6"><%= formatCurrency(entry.PricePerSqFt) %></td>
                      <td class="py-4 px-6"><%= entry.DaysOnMarket %> days</td>
                      <td class="py-4 px-6">
                        <% if (priceChange !== 0) { %>
                          <span class="inline-flex items-center space-x-1 <%= priceChange > 0 ? 'text-green-600' : 'text-red-600' %>">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                d="<%= priceChange > 0 
                                  ? 'M13 7h8m0 0v8m0-8l-8 8-4-4-6 6' 
                                  : 'M13 17h8m0 0V9m0 8l-8-8-4 4-6-6' %>"
                              />
                            </svg>
                            <span><%= formatCurrency(Math.abs(priceChange)) %></span>
                          </span>
                        <% } %>
                      </td>
                    </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>
          <% } else { %>
            <div class="text-center py-8 text-gray-500">
              <svg class="w-16 h-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              <p class="text-lg">No price history available for this property.</p>
            </div>
          <% } %>
        </section>
      </div>
    </div>
    
    <!-- Monthly Payment Section -->
    <div class="bg-white rounded-lg shadow">
      <button class="toggle-button w-full flex justify-between items-center p-4 font-semibold text-xl border-b hover:bg-gray-50 transition-colors duration-200" onclick="toggleSection('monthlyPayment', this)">
        <span>Monthly Payment</span>
        <svg class="toggle-arrow w-6 h-6 transition-transform duration-200" fill="currentColor" viewBox="0 0 20 20">
          <path d="M5.23 7.21a.75.75 0 011.06-.02L10 10.8l3.71-3.61a.75.75 0 011.04 1.08l-4.24 4.12a.75.75 0 01-1.04 0L5.21 8.27a.75.75 0 01.02-1.06z"/>
        </svg>
      </button>
      <div id="monthlyPayment" class="p-4">
        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <!-- Left Column: Chart and Legend -->
          <div class="space-y-6">
            <!-- Estimated Payment Header -->
            <div class="text-center">
              <h2 class="text-3xl font-semibold">Est. Monthly Payment</h2>
              <p class="text-gray-600 mt-1">Based on current market rates</p>
            </div>

            <!-- Pie Chart container -->
            <div class="relative">
              <canvas id="payment-breakdown-chart" class="w-full h-64"></canvas>
              <!-- Centered Payment Value -->
              <div id="estimated-payment" class="absolute inset-0 flex items-center justify-center">
                <span class="text-gray-800 text-3xl font-bold" id="estimated-payment-value">$0.00</span>
              </div>
            </div>

            <!-- Legend -->
            <div class="flex flex-col space-y-2 bg-gray-50 p-4 rounded-lg">
              <div class="flex items-center">
                <span class="w-4 h-4 bg-blue-500 mr-2 rounded"></span>
                <span>Principal & Interest: <span id="legend-principal-interest" class="font-semibold">$0.00</span></span>
              </div>
              <div class="flex items-center">
                <span class="w-4 h-4 bg-teal-500 mr-2 rounded"></span>
                <span>Property Taxes: <span id="legend-property-taxes" class="font-semibold">$0.00</span></span>
              </div>
              <div class="flex items-center">
                <span class="w-4 h-4 bg-purple-500 mr-2 rounded"></span>
                <span>Home Insurance: <span id="legend-home-insurance" class="font-semibold">$0.00</span></span>
              </div>
            </div>
          </div>

          <!-- Right Column: Calculator Controls -->
          <div class="space-y-6">
            <div>
              <h3 class="text-xl font-semibold mb-4">Customize Payment</h3>
              <div class="space-y-4">
                <div>
                  <label for="custom-down-payment" class="block text-gray-700 font-semibold">Down Payment</label>
                  <input type="number" id="custom-down-payment" value="50000" class="w-full px-4 py-2 border rounded-md" />
                </div>
                <div>
                  <label for="custom-interest-rate" class="block text-gray-700 font-semibold">Interest Rate (%)</label>
                  <input type="number" id="custom-interest-rate" value="3.5" class="w-full px-4 py-2 border rounded-md" />
                </div>
                <button onclick="signInToSaveChanges()" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                  Sign in to save changes
                </button>
              </div>
            </div>

            <!-- Payment Breakdown -->
            <div class="bg-gray-50 p-4 rounded-lg">
              <h4 class="font-semibold mb-3">Payment Breakdown</h4>
              <ul class="space-y-2">
                <% ['Principal & Interest', 'Mortgage Insurance', 'Property Taxes', 'Home Insurance', 'HOA Fees', 'Utilities'].forEach(item => { %>
                  <li>
                    <details>
                      <summary class="flex justify-between items-center cursor-pointer hover:bg-gray-100 p-2 rounded">
                        <span><%= item %></span>
                        <span id="breakdown-<%= item.toLowerCase().replace(/[&\s]/g, '-') %>">$0.00</span>
                      </summary>
                      <div class="mt-2 pl-4 text-gray-600">
                        <!-- Additional details can be added here -->
                      </div>
                    </details>
                  </li>
                <% }); %>
              </ul>
            </div>
          </div>
        </div>

        <!-- Footer Section -->
        <div class="mt-8 space-y-4">
          <!-- Disclaimer -->
          <div class="text-sm text-gray-600 bg-gray-50 p-4 rounded-lg">
            <p>Calculations are estimates and provided for informational purposes only. Actual amounts may vary.</p>
            <p>Factors affecting rates include credit score and down payment amount.</p>
          </div>

          <!-- Call-to-Action -->
          <button class="w-full sm:w-auto px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none">
            Get pre-qualified
          </button>
        </div>
      </div>
    </div>

    <!-- Schools Section -->
    <div class="bg-white rounded-lg shadow">
      <button class="toggle-button w-full flex justify-between items-center p-4 font-semibold text-xl border-b hover:bg-gray-50 transition-colors duration-200" onclick="toggleSection('schools', this)">
        <span>Schools</span>
        <!-- Arrow Icon -->
        <svg class="toggle-arrow w-6 h-6 transition-transform duration-200" fill="currentColor" viewBox="0 0 20 20">
          <path d="M5.23 7.21a.75.75 0 011.06-.02L10 10.8l3.71-3.61a.75.75 0 011.04 1.08l-4.24 4.12a.75.75 0 01-1.04 0L5.21 8.27a.75.75 0 01.02-1.06z" />
        </svg>
      </button>
      <div id="schools" class="p-4 hidden">
        <section>
          <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-6">
            <h3 class="text-2xl font-semibold mb-4 md:mb-0">Nearby Schools</h3>
            <!-- Filter Controls - Added left and right margins -->
            <div class="flex flex-wrap gap-3 md:mx-4">
              <select id="school-level-filter" class="px-4 py-1 pr-8 border rounded-md text-sm text-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-200 appearance-none bg-white relative">
                <option value="">All Levels</option>
                <option value="Elementary">Elementary</option>
                <option value="Middle">Middle</option>
                <option value="High">High</option>
                <option value="Private">Private</option>
              </select>
            </div>
          </div>

          <!-- School List Container -->
          <% if (schools && schools.length > 0) { %>
            <div id="schools-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              <% schools.forEach(function(school) { %>
                <div
                  class="bg-white shadow-md rounded-lg p-6 hover:shadow-lg transition-shadow duration-200 border border-gray-100"
                  data-level="<%= school.Level %>"
                  data-distance="<%= school.Distance %>"
                >
                  <!-- Rating Badge - Moved to top right -->
                  <div class="flex justify-between items-start mb-3">
                    <h4 class="text-xl font-semibold"><%= formatText(school.Name) %></h4>
                    <% if (school.Rating != null) { %>
                      <span
                        class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
                          <%= school.Rating >= 8 ? 'bg-green-100 text-green-800' :
                             school.Rating >= 6 ? 'bg-blue-100 text-blue-800' :
                             'bg-yellow-100 text-yellow-800' %>"
                      >
                        <%= school.Rating %>/10
                      </span>
                    <% } %>
                  </div>

                  <!-- School Info with improved spacing and organization -->
                  <div class="space-y-2 text-gray-600">
                    <div class="flex justify-between items-center py-1 border-b border-gray-100">
                      <span class="font-medium">Level:</span>
                      <span><%= formatText(school.Level) %></span>
                    </div>
                    <div class="flex justify-between items-center py-1 border-b border-gray-100">
                      <span class="font-medium">Grades:</span>
                      <span><%= formatText(school.Grades) %></span>
                    </div>
                    <div class="flex justify-between items-center py-1 border-b border-gray-100">
                      <span class="font-medium">Distance:</span>
                      <span class="text-blue-600">
                        <%= school.Distance != null ? school.Distance + ' miles' : 'N/A' %>
                      </span>
                    </div>
                    <div class="flex justify-between items-center py-1">
                      <span class="font-medium">Students:</span>
                      <span>
                        <%= school.Students != null ? school.Students.toLocaleString() : 'N/A' %>
                      </span>
                    </div>
                  </div>

                  <!-- View Details Link -->
                  <div class="mt-4 pt-3 border-t border-gray-100">
                    <a href="#" class="text-blue-600 hover:text-blue-800 text-sm font-medium flex justify-between items-center">
                      View School Details
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                      </svg>
                    </a>
                  </div>
                </div>
              <% }); %>
            </div>
          <% } else { %>
            <div class="text-center py-8 bg-gray-50 rounded-lg">
              <p class="text-gray-600">No nearby school information available.</p>
            </div>
          <% } %>
        </section>
      </div>
    </div>

    <!-- Map Section -->
    <div class="bg-white rounded-lg shadow">
      <button class="toggle-button w-full flex justify-between items-center p-4 font-semibold text-xl border-b" onclick="toggleSection('map', this)">
        <span>Map</span>
        <!-- Arrow Icon -->
        <svg class="toggle-arrow w-6 h-6 transition-transform duration-200" fill="currentColor" viewBox="0 0 20 20">
          <path d="M5.23 7.21a.75.75 0 011.06-.02L10 10.8l3.71-3.61a.75.75 0 011.04 1.08l-4.24 4.12a.75.75 0 01-1.04 0L5.21 8.27a.75.75 0 01.02-1.06z"/>
        </svg>
      </button>
      <div id="map" class="p-4 hidden">
        <!-- Map Content -->
        <section>
          <h3 class="text-2xl font-semibold mb-4">Location</h3>
          <div class="w-full h-96">
            <!-- Embed a map with the property's location -->
            <iframe src="https://www.google.com/maps/embed/v1/place?key=YOUR_API_KEY&q=<%= encodeURIComponent(property.Address + ', ' + property.City + ', ' + property.State + ' ' + property.ZipCode) %>" class="w-full h-full rounded-lg" allowfullscreen></iframe>
          </div>
        </section>
      </div>
    </div>

    <!-- Tax History Section -->
    <div class="bg-white rounded-lg shadow">
      <button class="toggle-button w-full flex justify-between items-center p-4 font-semibold text-xl border-b hover:bg-gray-50" onclick="toggleSection('taxHistory', this)">
        <span>Tax History</span>
        <svg class="toggle-arrow w-6 h-6 transition-transform duration-200" fill="currentColor" viewBox="0 0 20 20">
          <path d="M5.23 7.21a.75.75 0 011.06-.02L10 10.8l3.71-3.61a.75.75 0 011.04 1.08l-4.24 4.12a.75.75 0 01-1.04 0L5.21 8.27a.75.75 0 01.02-1.06z"/>
        </svg>
      </button>
      
      <div id="taxHistory" class="p-6 hidden">
        <section>
          <!-- Header with summary -->
          <div class="mb-6">
            <h3 class="text-2xl font-semibold mb-2">Tax History</h3>
            <p class="text-gray-600">Track historical property tax assessments and payments</p>
          </div>

          <% if (taxHistory && taxHistory.length > 0) { %>
            <!-- Tax Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              <div class="bg-blue-50 p-4 rounded-lg">
                <div class="text-sm text-gray-600 mb-1">Current Year Taxes</div>
                <div class="text-2xl font-bold text-blue-700">
                  <%= formatCurrency(taxHistory[0].Taxes) %>
                </div>
                <% 
                  const taxChange = taxHistory[0].Taxes - taxHistory[1].Taxes;
                  const taxChangePercent = (taxChange / taxHistory[1].Taxes) * 100;
                %>
                <div class="text-sm mt-2 flex items-center">
                  <span class="<%= taxChange >= 0 ? 'text-red-600' : 'text-green-600' %>">
                    <%= taxChange >= 0 ? '↑' : '↓' %> <%= Math.abs(taxChangePercent).toFixed(1) %>%
                  </span>
                  <span class="text-gray-600 ml-1">from previous year</span>
                </div>
              </div>

              <div class="bg-gray-50 p-4 rounded-lg">
                <div class="text-sm text-gray-600 mb-1">Current Assessment</div>
                <div class="text-2xl font-bold text-gray-700">
                  <%= formatCurrency(taxHistory[0].TotalAssessment) %>
                </div>
                <div class="text-sm text-gray-500 mt-2">
                  Last updated: <%= new Date().getFullYear() %>
                </div>
              </div>

              <div class="bg-gray-50 p-4 rounded-lg">
                <div class="text-sm text-gray-600 mb-1">Tax Rate</div>
                <div class="text-2xl font-bold text-gray-700">
                  <%= ((taxHistory[0].Taxes / taxHistory[0].TotalAssessment) * 100).toFixed(2) %>%
                </div>
                <div class="text-sm text-gray-500 mt-2">
                  Based on current assessment
                </div>
              </div>
            </div>

            <!-- Interactive Table -->
            <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
              <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead>
                    <tr class="bg-gray-50">
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Year</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Taxes</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assessment</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Change</th>
                    </tr>
                  </thead>
                  <tbody class="bg-white divide-y divide-gray-200">
                    <% taxHistory.forEach(function(entry, index) { 
                      const prevEntry = taxHistory[index + 1];
                      const change = prevEntry ? entry.Taxes - prevEntry.Taxes : 0;
                      const changePercent = prevEntry ? (change / prevEntry.Taxes) * 100 : 0;
                    %>
                      <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                          <%= entry.Year %>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                          <%= formatCurrency(entry.Taxes) %>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                          <%= formatCurrency(entry.TotalAssessment) %>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                          <% if (prevEntry) { %>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                              <%= change > 0 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800' %>">
                              <%= change >= 0 ? '+' : '-' %><%= Math.abs(changePercent).toFixed(1) %>%
                            </span>
                          <% } else { %>
                            <span class="text-gray-500">-</span>
                          <% } %>
                        </td>
                      </tr>
                    <% }); %>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Information Note -->
            <div class="mt-6 bg-yellow-50 border-l-4 border-yellow-400 p-4">
              <div class="flex">
                <div class="flex-shrink-0">
                  <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                  </svg>
                </div>
                <div class="ml-3">
                  <p class="text-sm text-yellow-700">
                    Tax information is for reference only. Contact your local tax assessor for the most current information.
                  </p>
                </div>
              </div>
            </div>
          <% } else { %>
            <div class="text-center py-8">
              <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              <h3 class="mt-2 text-sm font-medium text-gray-900">No tax history</h3>
              <p class="mt-1 text-sm text-gray-500">No tax history is available for this property.</p>
            </div>
          <% } %>
        </section>
      </div>
    </div>

    <!-- Environmental Risks Section -->
    <div class="bg-white rounded-lg shadow">
      <button class="toggle-button w-full flex justify-between items-center p-4 font-semibold text-xl border-b transition-colors duration-200 hover:bg-gray-50" onclick="toggleSection('environmentalRisks', this)">
        <!-- Title with Risk Summary Badge -->
        <div class="flex items-center space-x-3">
          <span>Environmental Risks</span>
          <% if (environmentalRisks && environmentalRisks.length > 0) { 
            const highRisks = environmentalRisks.filter(risk => risk.Level === 'Major').length;
          %>
            <span class="px-2 py-1 text-sm rounded-full <%= highRisks >= 3 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800' %>">
              <%= highRisks >= 3 ? `${highRisks} Major Risks` : 'Minimal Risk Area' %>
            </span>
          <% } %>
        </div>
        <!-- Arrow Icon -->
        <svg class="toggle-arrow w-6 h-6 transition-transform duration-200" fill="currentColor" viewBox="0 0 20 20">
          <path d="M5.23 7.21a.75.75 0 011.06-.02L10 10.8l3.71-3.61a.75.75 0 011.04 1.08l-4.24 4.12a.75.75 0 01-1.04 0L5.21 8.27a.75.75 0 01.02-1.06z"/>
        </svg>
      </button>

      <div id="environmentalRisks" class="p-6 hidden">
        <section>
          <!-- Risk Overview -->
          <div class="mb-6">
            <h3 class="text-2xl font-semibold mb-2">Environmental Risk Assessment</h3>
            <p class="text-gray-600">Understanding potential environmental risks helps make informed decisions about property investment and safety.</p>
          </div>

          <% if (environmentalRisks && environmentalRisks.length > 0) { %>
            <!-- Risk Cards Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
              <% 
                const riskIcons = {
                  'Flood': `<i class="fa-solid fa-water w-6 h-6"></i>`,
                  'Fire': `<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z" />
                  </svg>`,
                  'Heat': `<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                  </svg>`,
                  'Wind': `<i class="fa-solid fa-wind w-6 h-6"></i>`,
                  'Air': `<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" />
                  </svg>`
                };
                const riskColors = {
                  'MINIMAL': {
                    bg: 'bg-green-50 hover:bg-green-100',
                    border: 'border-green-200',
                    text: 'text-green-700'
                  },
                  'MODERATE': {
                    bg: 'bg-yellow-50 hover:bg-yellow-100',
                    border: 'border-yellow-200',
                    text: 'text-yellow-700'
                  },
                  'MAJOR': {
                    bg: 'bg-red-50 hover:bg-red-100',
                    border: 'border-red-200',
                    text: 'text-red-700'
                  }
                };

                // Helper function to get risk colors with fallback
                function getRiskColors(riskLevel) {
                  // Convert to uppercase for case-insensitive comparison
                  const level = (riskLevel || '').toUpperCase();
                  return riskColors[level] || {
                    bg: 'bg-gray-50 hover:bg-gray-100',
                    border: 'border-gray-200',
                    text: 'text-gray-700'
                  };
                }
              %>
              <% environmentalRisks.forEach(function(risk) { 
                const colors = getRiskColors(risk.Level);
              %>
                <div class="rounded-lg border p-4 transition-all duration-200 <%= colors.bg %> <%= colors.border %> hover:shadow-md">
                  <!-- Risk Header with Icon -->
                  <div class="flex justify-between items-start mb-3">
                    <div class="flex items-center space-x-2">
                      <div class="<%= colors.text %>">
                        <%- riskIcons[risk.RiskType] %>
                      </div>
                      <h4 class="font-semibold text-gray-900"><%= risk.RiskType %></h4>
                    </div>
                    <span class="px-2 py-1 text-sm rounded-full font-medium <%= colors.text %> <%= colors.bg %>">
                      <%= risk.Level %> Risk
                    </span>
                  </div>
                  
                  <!-- Risk Description -->
                  <p class="text-gray-600 text-sm mb-3"><%= formatText(risk.Description) %></p>
                  
                  <!-- Risk Details Button -->
                  <button onclick="showRiskDetails('<%= risk.RiskType %>')" 
                          class="inline-flex items-center text-sm font-medium <%= colors.text %> hover:underline">
                    Learn More
                    <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                  </button>
                </div>
              <% }); %>
            </div>

            <!-- Risk Mitigation Tips -->
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
              <h4 class="font-semibold text-gray-800 mb-2 flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Risk Mitigation Tips
              </h4>
              <ul class="text-gray-700 space-y-2">
                <li class="flex items-start">
                  <svg class="w-5 h-5 mr-2 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                  </svg>
                  Consider getting additional insurance coverage for identified risks
                </li>
                <li class="flex items-start">
                  <svg class="w-5 h-5 mr-2 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                  </svg>
                  Consult with environmental experts for detailed assessment
                </li>
                <li class="flex items-start">
                  <svg class="w-5 h-5 mr-2 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                  </svg>
                  Review local regulations and building codes
                </li>
              </ul>
            </div>

            <!-- Data Source Information -->
            <div class="text-sm text-gray-500 flex items-center">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <div>
                <p>Data sources: FEMA, EPA, and local environmental agencies</p>
                <p>Last updated: <%= new Date().toLocaleDateString() %></p>
              </div>
            </div>
          <% } else { %>
            <div class="text-center py-8">
              <svg class="mx-auto h-12 w-12 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <h3 class="mt-2 text-sm font-medium text-gray-900">No Environmental Risks</h3>
              <p class="mt-1 text-sm text-gray-500">This property has no significant environmental risks on record.</p>
            </div>
          <% } %>
        </section>
      </div>
    </div>

    <!-- Amenities Section -->
    <%
      // Group amenities by category
      const amenitiesByCategory = {};
      amenities.forEach(amenity => {
        const category = amenity.Category || 'Other';
        if (!amenitiesByCategory[category]) {
          amenitiesByCategory[category] = [];
        }
        amenitiesByCategory[category].push(amenity);
      });

      // Define icons for each category
      const categoryIcons = {
        'Daycare': 'fa-child',
        'Grocery': 'fa-shopping-basket',
        'Park': 'fa-tree',
        'Shopping': 'fa-shopping-cart',
        'Cafe': 'fa-coffee',
        'Restaurant': 'fa-utensils',
        'Wellness': 'fa-heart',
        'Transportation': 'fa-bus',
        'Other': 'fa-circle-info'
      };
    %>

    <div class="bg-white rounded-lg shadow">
      <!-- Section Header -->
      <button class="toggle-button w-full flex justify-between items-center p-4 font-semibold text-xl border-b hover:bg-gray-50" onclick="toggleSection('amenities', this)">
        <div class="flex items-center space-x-2">
          <span>Amenities & Features</span>
          <span class="text-sm font-normal text-gray-500">
            (<%= Object.values(amenitiesByCategory).flat().length %> total)
          </span>
        </div>
        <svg class="toggle-arrow w-6 h-6 transition-transform duration-200" fill="currentColor" viewBox="0 0 20 20">
          <path d="M5.23 7.21a.75.75 0 011.06-.02L10 10.8l3.71-3.61a.75.75 0 011.04 1.08l-4.24 4.12a.75.75 0 01-1.04 0L5.21 8.27a.75.75 0 01.02-1.06z"/>
        </svg>
      </button>

      <!-- Section Content -->
      <div id="amenities" class="p-6 hidden">
        <% if (amenitiesByCategory && Object.keys(amenitiesByCategory).length > 0) { %>
          <!-- Category Pills -->
          <div class="flex flex-wrap gap-2 mb-6">
            <button 
              onclick="showAllAmenities()" 
              class="category-pill active px-4 py-2 rounded-full bg-blue-600 text-white hover:bg-blue-700 transition-colors">
              All
            </button>
            <% Object.keys(amenitiesByCategory).forEach(category => { %>
              <button 
                onclick="filterAmenitiesByCategory('<%= category %>')" 
                class="category-pill px-4 py-2 rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors">
                <i class="fas <%= categoryIcons[category] || 'fa-circle-info' %> mr-1"></i>
                <%= category %>
                <span class="text-sm text-gray-500 ml-1">
                  (<%= amenitiesByCategory[category].length %>)
                </span>
              </button>
            <% }); %>
          </div>

          <!-- Amenities Grid -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <% Object.keys(amenitiesByCategory).forEach(category => { %>
              <div class="amenity-category" data-category="<%= category %>">
                <div class="bg-gray-50 rounded-xl p-4 h-full hover:shadow-md transition-shadow duration-200">
                  <!-- Category Header -->
                  <div class="flex items-center space-x-2 mb-4 pb-2 border-b border-gray-200">
                    <i class="fas <%= categoryIcons[category] || 'fa-circle-info' %> text-blue-600 text-lg"></i>
                    <h3 class="text-lg font-semibold text-gray-800"><%= category %></h3>
                  </div>
                  
                  <!-- Amenities List -->
                  <ul class="list-disc list-inside space-y-2">
                    <% amenitiesByCategory[category].forEach(amenity => { %>
                      <li class="amenity-item text-gray-700 hover:bg-white p-2 rounded-lg transition-colors">
                        <span class="text-sm"><%= formatText(amenity.Name) %></span>
                        <% if (amenity.Description) { %>
                          <i class="fas fa-info-circle text-gray-400 ml-2 cursor-help" 
                             title="<%= amenity.Description %>">
                          </i>
                        <% } %>
                      </li>
                    <% }); %>
                  </ul>
                </div>
              </div>
            <% }); %>
          </div>

        <% } else { %>
          <!-- Empty State -->
          <div class="text-center py-8">
            <i class="fas fa-home text-gray-400 text-4xl mb-4"></i>
            <p class="text-gray-500">No amenities information available for this property.</p>
          </div>
        <% } %>

        <!-- Footer Note -->
        <div class="mt-6 text-sm text-gray-500 bg-gray-50 p-4 rounded-lg">
          <p class="flex items-center">
            <i class="fas fa-info-circle mr-2"></i>
            Some amenities may be subject to additional fees or restrictions. Please contact the property for detailed information.
          </p>
        </div>
      </div>
    </div>

    <!-- Market Trends Section -->
    <div class="bg-white rounded-lg shadow">
      <button class="toggle-button w-full flex justify-between items-center p-4 font-semibold text-xl border-b hover:bg-gray-50" onclick="toggleSection('marketTrends', this)">
        <div class="flex items-center space-x-3">
          <span>Market Trends</span>
          <span class="px-2 py-1 text-sm rounded-full font-medium bg-blue-100 text-blue-800">
            <%= marketTrends.City %>, <%= marketTrends.State %>
          </span>
        </div>
        <svg class="toggle-arrow w-6 h-6 transition-transform duration-200" fill="currentColor" viewBox="0 0 20 20">
          <path d="M5.23 7.21a.75.75 0 011.06-.02L10 10.8l3.71-3.61a.75.75 0 011.04 1.08l-4.24 4.12a.75.75 0 01-1.04 0L5.21 8.27a.75.75 0 01.02-1.06z"/>
        </svg>
      </button>

      <div id="marketTrends" class="p-6 hidden">
        <% if (marketTrends) { %>
          <!-- Primary Market Metrics -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- Median Listing Price -->
            <div class="bg-gradient-to-br from-blue-50 to-white rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-gray-600 font-medium">Median Listing Price</h3>
                <i class="fas fa-tag text-blue-600 text-2xl"></i>
              </div>
              <p class="text-3xl font-bold text-gray-900 mb-2">
                <%= formatCurrency(marketTrends.ListingPriceMedian) %>
              </p>
              <p class="text-sm text-gray-500">Current Market Listings</p>
            </div>

            <!-- Median Sold Price -->
            <div class="bg-gradient-to-br from-green-50 to-white rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-gray-600 font-medium">Median Sold Price</h3>
                <i class="fas fa-hand-holding-usd text-green-600 text-2xl"></i>
              </div>
              <p class="text-3xl font-bold text-gray-900 mb-2">
                <%= formatCurrency(marketTrends.SoldPriceMedian) %>
              </p>
              <p class="text-sm text-gray-500">Recent Sales</p>
            </div>

            <!-- Price Per Sq Ft -->
            <div class="bg-gradient-to-br from-purple-50 to-white rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-gray-600 font-medium">Price Per Sq Ft</h3>
                <i class="fas fa-ruler-combined text-purple-600 text-2xl"></i>
              </div>
              <p class="text-3xl font-bold text-gray-900 mb-2">
                <%= formatCurrency(marketTrends.ListPricePerSqFtMedian) %>
              </p>
              <p class="text-sm text-gray-500">Median Price/Sq Ft</p>
            </div>
          </div>

          <!-- Market Speed Indicator -->
          <div class="bg-gray-50 rounded-xl p-6 mb-8">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold">Market Speed</h3>
              <span class="px-3 py-1 rounded-full text-sm font-medium 
                    <%= marketTrends.DaysOnMarketMedian <= 30 ? 'bg-green-100 text-green-800' : 
                       marketTrends.DaysOnMarketMedian <= 60 ? 'bg-yellow-100 text-yellow-800' : 
                       'bg-red-100 text-red-800' %>" 
                    data-market-speed="<%= marketTrends.DaysOnMarketMedian %>">
                <%= marketTrends.DaysOnMarketMedian %> days on market
              </span>
            </div>
            
            <p class="text-gray-700 mb-4">
              <% if (marketTrends.DaysOnMarketMedian <= 30) { %>
                Properties in this market are moving quickly, with a median time of <%= marketTrends.DaysOnMarketMedian %> days on market. Buyers should be prepared to act quickly and make competitive offers.
              <% } else if (marketTrends.DaysOnMarketMedian <= 60) { %>
                With properties spending a median of <%= marketTrends.DaysOnMarketMedian %> days on market, this area is moving at a moderate pace. Buyers have time to make informed decisions while remaining competitive.
              <% } else { %>
                The current market shows properties typically spending <%= marketTrends.DaysOnMarketMedian %> days on market before selling. This slower pace means buyers may have more negotiating power and time to consider their options.
              <% } %>
            </p>

            <div class="text-sm text-gray-500 flex items-center">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              Market speed can vary by price range and location
            </div>
          </div>

          <!-- Market Analysis -->
          <div class="bg-blue-50 rounded-xl p-6">
            <h3 class="text-lg font-semibold mb-3">Market Analysis</h3>
            <div class="space-y-4 text-gray-700">
              <p>
                In <%= marketTrends.City %>, the median listing price is currently 
                <%= formatCurrency(marketTrends.ListingPriceMedian) %>, with properties selling at a median price of 
                <%= formatCurrency(marketTrends.SoldPriceMedian) %>. 
              </p>
              <p>
                Properties in this market are selling in approximately <%= marketTrends.DaysOnMarketMedian %> days, 
                with an average price per square foot of <%= formatCurrency(marketTrends.ListPricePerSqFtMedian) %>.
              </p>
            </div>
          </div>

          <!-- Data Source Note -->
          <div class="mt-6 text-sm text-gray-500 flex items-center">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            Data updated <%= new Date().toLocaleDateString() %>. Source: Local MLS
          </div>
        <% } else { %>
          <!-- Empty State -->
          <div class="text-center py-8">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">No Market Data</h3>
            <p class="mt-1 text-sm text-gray-500">Market trend information is not available for this area.</p>
          </div>
        <% } %>
      </div>
    </div>

    <!-- Nearby Home Values Section -->
    <div class="bg-white rounded-lg shadow">
      <button class="toggle-button w-full flex justify-between items-center p-4 font-semibold text-xl border-b hover:bg-gray-50 transition-colors duration-200" onclick="toggleSection('nearbyHomeValues', this)">
        <div class="flex items-center space-x-3">
          <span>Nearby Home Values</span>
          <% if (nearbyHomeValues && nearbyHomeValues.length > 0) { %>
            <span class="px-2 py-1 text-sm rounded-full bg-blue-100 text-blue-800">
              <%= nearbyHomeValues.length %> properties
            </span>
          <% } %>
        </div>
        <svg class="toggle-arrow w-6 h-6 transition-transform duration-200" fill="currentColor" viewBox="0 0 20 20">
          <path d="M5.23 7.21a.75.75 0 011.06-.02L10 10.8l3.71-3.61a.75.75 0 011.04 1.08l-4.24 4.12a.75.75 0 01-1.04 0L5.21 8.27a.75.75 0 01.02-1.06z"/>
        </svg>
      </button>

      <div id="nearbyHomeValues" class="p-6 hidden">
        <!-- Section Header with Filters -->
        <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-6">
          <div>
            <h2 class="text-2xl font-semibold mb-2">Nearby Home Values</h2>
            <p class="text-gray-600">Properties within a 1-mile radius</p>
          </div>
          <!-- Filter Controls -->
          <div class="flex flex-wrap gap-3 mt-4 md:mt-0">
            <select class="px-4 py-2 border rounded-lg text-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-200">
              <option value="distance">Distance</option>
              <option value="0.5">0.5 miles</option>
              <option value="1">1 mile</option>
              <option value="2">2 miles</option>
            </select>
            <select class="px-4 py-2 border rounded-lg text-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-200">
              <option value="price">Price Range</option>
              <option value="lower">Lower</option>
              <option value="similar">Similar</option>
              <option value="higher">Higher</option>
            </select>
          </div>
        </div>

        <% if (nearbyHomeValues && nearbyHomeValues.length > 0) { %>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <% nearbyHomeValues.forEach(function(home) { %>
              <!-- Property Card -->
              <div class="bg-white rounded-xl border border-gray-200 overflow-hidden hover:shadow-lg transition-shadow duration-200">
                <!-- Property Image -->
                <div class="relative h-48 bg-gray-200">
                  <% if (home.ImageUrl) { %>
                    <img src="<%= home.ImageUrl %>" alt="<%= home.Address %>" class="w-full h-full object-cover">
                  <% } else { %>
                    <div class="w-full h-full flex items-center justify-center bg-gray-100">
                      <i class="fas fa-home text-gray-400 text-4xl"></i>
                    </div>
                  <% } %>
                  <!-- Distance Badge -->
                  <span class="absolute top-2 right-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded-full text-sm">
                    <%= home.Distance %> mi
                  </span>
                </div>

                <!-- Property Details -->
                <div class="p-4">
                  <!-- Address and Value -->
                  <div class="mb-3">
                    <h4 class="text-lg font-semibold text-gray-900 mb-1 truncate"><%= formatText(home.Address) %></h4>
                    <div class="text-xl font-bold text-blue-600"><%= formatCurrency(home.ValueEstimate) %></div>
                  </div>

                  <!-- Property Specs -->
                  <div class="flex items-center space-x-4 text-gray-600 mb-3">
                    <div class="flex items-center">
                      <i class="fas fa-bed mr-1"></i>
                      <span><%= home.Bedrooms != null ? home.Bedrooms : 'N/A' %></span>
                    </div>
                    <div class="flex items-center">
                      <i class="fas fa-bath mr-1"></i>
                      <span><%= home.Bathrooms != null ? home.Bathrooms : 'N/A' %></span>
                    </div>
                    <div class="flex items-center">
                      <i class="fas fa-ruler-combined mr-1"></i>
                      <span><%= formatNumber(home.SquareFeet) %> sqft</span>
                    </div>
                  </div>

                  <!-- Price Comparison -->
                  <% 
                    const priceDiff = home.ValueEstimate - property.ListingPrice;
                    const priceDiffPercent = (priceDiff / property.ListingPrice) * 100;
                  %>
                  <div class="text-sm <%= priceDiff > 0 ? 'text-green-600' : 'text-red-600' %>">
                    <i class="fas <%= priceDiff > 0 ? 'fa-arrow-up' : 'fa-arrow-down' %> mr-1"></i>
                    <%= Math.abs(priceDiffPercent).toFixed(1) %>% <%= priceDiff > 0 ? 'more' : 'less' %> than listing
                  </div>
                </div>

                <!-- Action Button -->
                <div class="px-4 pb-4">
                  <button class="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    View Details
                  </button>
                </div>
              </div>
            <% }); %>
          </div>

          <!-- View More Button -->
          <div class="text-center mt-8">
            <button class="px-6 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
              View More Properties
            </button>
          </div>
        <% } else { %>
          <!-- Empty State -->
          <div class="text-center py-12 bg-gray-50 rounded-xl">
            <i class="fas fa-home text-gray-400 text-4xl mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No Nearby Properties</h3>
            <p class="text-gray-600">We couldn't find any comparable properties in the area.</p>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</div>


  <!-- Chatbot Section-->
  <%- include('partials/chatbot.ejs') %>

  <!-- Footer -->
  <footer class="bg-blue-900 text-white text-center py-4">
    <p>© 2024 Pasaana. All rights reserved.</p>
  </footer>

  <!-- Swiper JS for the image carousel -->
  <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>

  <!-- Include Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Pass server-side variables to client-side JavaScript -->
  <script>
    var imageCategories = <%- JSON.stringify(imageCategories) %>;
    var property = <%- JSON.stringify(property) %>;
  </script>

  <!-- Include your external JavaScript file -->
  <script src="/property.js"></script>
</body>
</html>


